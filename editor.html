<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Main</title>
    <script src="elm-editor/lib/codemirror.js"></script>
    <link rel="stylesheet" href="elm-editor/lib/codemirror.css">
    <script src="elm-editor/lib/markdown.js"></script>
    <script src="elm-editor/main.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<body>
    <div id="cm">
	<textarea id="cm-textarea">
	</textarea>
    </div>

    <div id="elm">
    </div>
</body>
<script>

 var urlParams = new URLSearchParams(window.location.search);
 
 var cm = CodeMirror.fromTextArea(document.getElementById("cm-textarea"));

 var app = Elm.Main.init({
     node: document.getElementById('elm'), 
     flags: { weave:  parseInt(urlParams.get('weave')), research: parseInt(urlParams.get('research')) }
 });

 
 
 // send current edit generation
 /* setInterval(function(){
  *     app.ports.currentGeneration.send(cm.changeGeneration());
  * }, 100);
  */

 cm.on("changes", function(){
     app.ports.currentGeneration.send(cm.changeGeneration());
 });



 cm.on("mousedown", function(){
     let pos = cm.getCursor();
     let tok = cm.getTokenTypeAt(pos);
     if (tok !== null && tok !== undefined) {
	 if (tok.includes("rcmedia")) {
	     let word = cm.findWordAt(pos);
	     let content = cm.getRange(word.anchor, word.head)
	     if (content !== "}" && content !== "!{") {
		 app.ports.mediaDialog.send( 
		     { media : content }
		 );
	     }
	 }
     }
 });
 
 
 function sendContent() {
     app.ports.cmContent.send( {
	 generation: cm.changeGeneration(),
	 content : cm.getValue()
     }
     );
 }
 
 app.ports.getContent.subscribe(function() {
     sendContent();
 });
 
 // cm.setValue()
 
</script>
</html>
